---
import BaseLayout from "./BaseLayout.astro";
import Sidebar from "@/components/docs/Sidebar.astro";
import TableOfContents from "@/components/docs/TableOfContents.astro";
import Breadcrumb from "@/components/docs/Breadcrumb.astro";
import SourceButton from "@/components/docs/SourceButton.astro";
import { buildNavigation, getActiveTab } from "@/lib/navigation";
import { buildBreadcrumbItems } from "@/lib/docs/breadcrumb";
import { navigation } from "@data/config";
import type { DocsLayoutProps, Heading } from "@/lib/docs/types";

const {
    currentSlug,
    headings = [],
    ...headProps
} = Astro.props as DocsLayoutProps;

// Build navigation
const navResult = await buildNavigation(navigation);
const activeTab = getActiveTab(currentSlug, navResult.tabs);

// Build breadcrumb items
const breadcrumbItems = buildBreadcrumbItems(currentSlug);

// Convert headings to TableOfContents format
const tableOfContentsHeadings = headings
    .map((h) => ({
        depth: h.depth,
        text: h.text,
        id: h.id ?? h.slug,
    }))
    .filter((heading): heading is Heading => Boolean(heading.id));
---

<BaseLayout {...headProps}>
    <div class="min-h-screen flex">
        <!-- Sidebar with tabs inside  -->
        <Sidebar
            tabs={navResult.tabs}
            showTabs={navResult.showTabs}
            activeTab={activeTab}
            currentSlug={currentSlug}
        />

        <!-- Main content  -->
        <main class="flex-1 px-8 py-6">
            <div class="flex items-center justify-between gap-4 mb-6">
                <Breadcrumb items={breadcrumbItems} />
                <SourceButton slug={currentSlug} />
            </div>
            <article class="prose prose-slate dark:prose-invert">
                <slot />
            </article>
        </main>

        <!-- Table of Contents on the right  -->
        <TableOfContents headings={tableOfContentsHeadings} />
    </div>
</BaseLayout>
