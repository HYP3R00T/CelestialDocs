---
import BaseLayout from "./BaseLayout.astro";
import Sidebar from "@/components/docs/Sidebar.astro";
import TableOfContents from "@/components/docs/TableOfContents.astro";
import Breadcrumb from "@/components/docs/Breadcrumb.astro";
import SourceButton from "@/components/docs/SourceButton.astro";
import { buildNavigation, getActiveTab } from "@/lib/navigation";
import { buildBreadcrumbItems } from "@/lib/docs/breadcrumb";
import { SIDEBAR_NAVIGATION } from "@data/config";
import type { DocsLayoutProps, Heading } from "@/lib/docs/types";

const { headings = [], frontmatter } = Astro.props as DocsLayoutProps &
    Record<string, unknown>;

// Build navigation
const navResult = await buildNavigation(SIDEBAR_NAVIGATION);
const activeTab = getActiveTab(frontmatter.id, navResult.tabs);

// Build breadcrumb items
const breadcrumbItems = buildBreadcrumbItems(frontmatter.id);

// Convert headings to TableOfContents format
const tableOfContentsHeadings = headings
    .map((h) => ({
        depth: h.depth,
        text: h.text,
        id: h.id ?? h.slug,
    }))
    .filter((heading): heading is Heading => Boolean(heading.id));
---

<BaseLayout>
    <div class="min-h-screen flex">
        <!-- Sidebar with tabs inside  -->
        <Sidebar
            tabs={navResult.tabs}
            showTabs={navResult.showTabs}
            activeTab={activeTab}
            currentSlug={frontmatter.id}
        />

        <!-- Main content  -->
        <main class="flex-1 lg:px-8 lg:py-6 min-w-0">
            <div class="flex items-center justify-between gap-4 mb-6">
                <div class="hidden lg:flex justify-between w-full items-center">
                    <div>
                        {
                            !frontmatter.data.hide_breadcrumbs && (
                                <Breadcrumb items={breadcrumbItems} />
                            )
                        }
                    </div>
                    <SourceButton slug={frontmatter.id} />
                </div>
            </div>
            <article class="prose prose-slate dark:prose-invert min-w-0">
                <h1>{frontmatter.data.title}</h1>
                <slot />
            </article>
        </main>

        <!-- Table of Contents on the right  -->
        <TableOfContents headings={tableOfContentsHeadings} />
    </div>
</BaseLayout>
