---
import BaseLayout from "./BaseLayout.astro";
import Sidebar from "@/components/docs/Sidebar.astro";
import TableOfContents from "@/components/docs/TableOfContents.astro";
import Breadcrumb from "@/components/docs/Breadcrumb.astro";
import SourceButton from "@/components/docs/SourceButton.astro";
import CodeCopyButton from "@/components/docs/CodeCopyButton.astro";
import { buildNavigation, getActiveTab } from "@/lib/navigation";
import { buildBreadcrumbItems } from "@/lib/docs/breadcrumb";
import { SIDEBAR_NAVIGATION } from "@data/config";
import type { DocsLayoutProps, Heading } from "@/lib/docs/types";

interface Props extends DocsLayoutProps {}

const props = Astro.props as Props;
const { headings = [], frontmatter, collection } = props;
const collectionId = collection ?? "docs";
const navResult = await buildNavigation(SIDEBAR_NAVIGATION, collectionId);
const activeTab = getActiveTab(frontmatter.id, navResult.tabs);

// Build breadcrumb items
const breadcrumbItems = buildBreadcrumbItems(frontmatter.id, collectionId);

// Convert headings to TableOfContents format
const tableOfContentsHeadings = headings
  .map((h) => ({
    depth: h.depth,
    text: h.text,
    id: h.slug,
  }))
  .filter((heading): heading is Heading => Boolean(heading.id));
---

<BaseLayout>
  <div class="min-h-screen flex">
    <!-- Sidebar with tabs inside  -->
    <Sidebar
      tabs={navResult.tabs}
      showTabs={navResult.showTabs}
      activeTab={activeTab}
      currentSlug={frontmatter.id}
      collectionId={collectionId}
    />

    <!-- Main content  -->
    <main class="docs-main flex-1 lg:py-6 min-w-0">
      <div class="flex items-center justify-between gap-4 mb-6">
        <div class="hidden lg:flex justify-between w-full items-center">
          <div>
            {
              !frontmatter.data.hide_breadcrumbs && (
                <Breadcrumb items={breadcrumbItems} />
              )
            }
          </div>
          <SourceButton slug={frontmatter.id} collectionId={collectionId} />
        </div>
      </div>
      <article class="prose prose-slate dark:prose-invert min-w-0">
        <h1>{frontmatter.data.title}</h1>
        <slot />
      </article>
    </main>

    <!-- Table of Contents on the right  -->
    <TableOfContents headings={tableOfContentsHeadings} />
  </div>
  <CodeCopyButton />
</BaseLayout>
