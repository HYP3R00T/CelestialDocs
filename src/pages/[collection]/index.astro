---
import { CONTENT, SIDEBAR_NAVIGATION } from "@data/config";
import { getCollection, render } from "astro:content";
import type { CollectionKey } from "astro:content";

import MdxImage from "@/components/docs/markdown/MdxImage.astro";
import MdxLink from "@/components/docs/markdown/MdxLink.astro";
import DocsLayout from "@/layouts/DocsLayout.astro";
import { buildNavigation } from "@/lib/navigation";

export async function getStaticPaths() {
    const paths: {
        params: { collection: CollectionKey };
        props: {
            collection: CollectionKey;
            nav: Awaited<ReturnType<typeof buildNavigation>>;
            doc: Awaited<ReturnType<typeof getCollection>>[number] | undefined;
        };
    }[] = [];

    for (const sys of CONTENT.systems) {
        const nav = await buildNavigation(SIDEBAR_NAVIGATION, sys.id);
        const entries = await getCollection(sys.id as CollectionKey);

        // Check if index doc exists, if not use the default redirect target
        let indexDoc = entries.find((entry) => entry.id === "index");

        if (!indexDoc) {
            // Find the default doc to render instead
            const defaultRedirect = sys.defaultDocRedirect;
            if (defaultRedirect) {
                // Extract slug from redirect path (e.g., "/docs/introduction" -> "introduction")
                const baseRoute = sys.route ?? `/${sys.id}`;
                const defaultSlug = defaultRedirect
                    .replace(baseRoute + "/", "")
                    .replace(/^\/+/, "");
                indexDoc = entries.find((entry) => entry.id === defaultSlug);
            }
        }

        paths.push({
            params: { collection: sys.id as CollectionKey },
            props: {
                collection: sys.id as CollectionKey,
                nav,
                doc: indexDoc,
            },
        });
    }

    return paths;
}

const collection = Astro.params.collection as CollectionKey;
const { nav, doc } = Astro.props as {
    collection: CollectionKey;
    nav: Awaited<ReturnType<typeof buildNavigation>>;
    doc: Awaited<ReturnType<typeof getCollection>>[number] | undefined;
};

if (!doc) {
    // Fallback to home if no doc found at all
    return Astro.redirect("/");
}

const { Content, headings } = await render(doc);

const components = {
    img: MdxImage,
    a: MdxLink,
};
---

<DocsLayout frontmatter={doc} headings={headings} collection={collection} nav={nav}>
    <Content components={components} />
</DocsLayout>
