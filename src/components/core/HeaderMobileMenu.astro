---
import { Icon } from "astro-icon/components";
import { Button } from "@/components/ui/button";
import {
    HEADER_SOCIAL_LINKS,
    HEADER_NAV_ITEMS,
    SIDEBAR_NAVIGATION,
} from "@data/config";
import SidebarGroup from "@/components/docs/SidebarGroup.astro";
import SidebarEntry from "@/components/docs/SidebarEntry.astro";
import DocIcon from "@/components/docs/DocIcon.astro";
import { buildNavigation, getActiveTab } from "@/lib/navigation";
import type { SidebarGroupItem } from "@/lib/docs/types";

const activeSocials = HEADER_SOCIAL_LINKS.filter((social) => social.active);
const menuPanelId = "mobile-menu";

// Extract current slug from URL
const pathname = Astro.url.pathname;
const isOnDocsPage = pathname.startsWith("/docs");
const docsMatch = pathname.match(/^\/docs\/(.+?)(\/)?$/);
const currentSlug = docsMatch ? docsMatch[1] : null;

// Build navigation for docs
const navResult = await buildNavigation(SIDEBAR_NAVIGATION);
const activeTab = currentSlug
    ? getActiveTab(currentSlug, navResult.tabs)
    : navResult.tabs[0] || null;

// Helper to find first entry in a group
function findFirstEntry(group: SidebarGroupItem): string | null {
    if (group.children && group.children.length > 0) {
        for (const child of group.children) {
            if ("slug" in child) {
                return child.slug;
            }
            const entry = findFirstEntry(child as SidebarGroupItem);
            if (entry) return entry;
        }
    }
    if (group.entries && group.entries.length > 0) {
        return group.entries[0].slug;
    }
    if (group.groups && group.groups.length > 0) {
        for (const subgroup of group.groups) {
            const entry = findFirstEntry(subgroup);
            if (entry) return entry;
        }
    }
    return null;
}

const showDocs = isOnDocsPage;
---

<div
    id={menuPanelId}
    class="fixed inset-0 z-40 hidden md:hidden bg-background"
    aria-hidden="true"
>
    <div class="flex h-full w-full flex-col px-4 pb-4 pt-19 overflow-hidden">
        <div
            class="mx-auto w-full max-w-md rounded-lg border border-border/50 bg-linear-to-b from-background/85 via-background/95 to-background/98 shadow-xl max-h-[calc(100vh-5.5rem)] overflow-y-auto"
        >
            <div class="flex flex-col gap-6 py-6">
                <!-- Main Navigation -->
                <nav
                    class="flex flex-col items-center gap-3 text-sm font-medium"
                >
                    {
                        HEADER_NAV_ITEMS.map(
                            ({ href, label, special, blank }) => (
                                <a
                                    href={href}
                                    target={blank ? "_blank" : undefined}
                                    rel={blank ? "noreferrer" : undefined}
                                    class={`tracking-wide transition hover:text-primary ${special ? "text-primary" : "text-muted-foreground"}`}
                                >
                                    {label}
                                </a>
                            ),
                        )
                    }
                </nav>

                <!-- Docs Sidenav Section -->
                {
                    showDocs && activeTab && (
                        <div class="docs-sidenav border-t border-border/40 pt-4 px-4">
                            <div class="flex flex-col gap-3">
                                {/* Docs Tabs */}
                                {navResult.showTabs && (
                                    <div class="space-y-2 mb-4">
                                        {navResult.tabs.map((tab) => {
                                            const isActive =
                                                activeTab?.id === tab.id;
                                            const firstEntry = findFirstEntry(
                                                tab.group,
                                            );
                                            const href = firstEntry
                                                ? `/docs/${firstEntry}`
                                                : `/docs`;

                                            return (
                                                <a
                                                    href={href}
                                                    data-tab-link
                                                    class={`
                      flex items-center gap-2 rounded-md px-3 py-2 text-sm font-medium transition-colors
                      ${
                          isActive
                              ? "bg-secondary text-secondary-foreground"
                              : "text-muted-foreground hover:bg-secondary/50 hover:text-foreground"
                      }
                    `}
                                                    aria-current={
                                                        isActive
                                                            ? "page"
                                                            : undefined
                                                    }
                                                >
                                                    <DocIcon
                                                        name={
                                                            tab.icon ||
                                                            "document"
                                                        }
                                                        class="h-4 w-4"
                                                        aria-hidden="true"
                                                    />
                                                    <span>{tab.label}</span>
                                                </a>
                                            );
                                        })}
                                    </div>
                                )}

                                {/* Docs Entries and Groups */}
                                <div class="space-y-2">
                                    {/* Ordered children (entries and groups) if present */}
                                    {activeTab.group.children &&
                                    activeTab.group.children.length > 0 ? (
                                        <div class="space-y-2">
                                            {activeTab.group.children.map(
                                                (child) =>
                                                    (child as any).slug ? (
                                                        <ul class="space-y-1">
                                                            <SidebarEntry
                                                                entry={
                                                                    child as any
                                                                }
                                                                currentSlug={
                                                                    currentSlug
                                                                }
                                                            />
                                                        </ul>
                                                    ) : (
                                                        <SidebarGroup
                                                            group={
                                                                child as any as SidebarGroupItem
                                                            }
                                                            currentSlug={
                                                                currentSlug
                                                            }
                                                        />
                                                    ),
                                            )}
                                        </div>
                                    ) : (
                                        <>
                                            {/* Root-level entries (if any) */}
                                            {activeTab.group.entries &&
                                                activeTab.group.entries.length >
                                                    0 && (
                                                    <ul class="space-y-1">
                                                        {activeTab.group.entries.map(
                                                            (entry) => (
                                                                <SidebarEntry
                                                                    entry={
                                                                        entry
                                                                    }
                                                                    currentSlug={
                                                                        currentSlug
                                                                    }
                                                                />
                                                            ),
                                                        )}
                                                    </ul>
                                                )}

                                            {/* Root-level groups */}
                                            {activeTab.group.groups &&
                                                activeTab.group.groups.length >
                                                    0 && (
                                                    <div class="space-y-2">
                                                        {activeTab.group.groups.map(
                                                            (group) => (
                                                                <SidebarGroup
                                                                    group={
                                                                        group
                                                                    }
                                                                    currentSlug={
                                                                        currentSlug
                                                                    }
                                                                />
                                                            ),
                                                        )}
                                                    </div>
                                                )}
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    )
                }

                <!-- Social Links -->
                <div
                    class="flex items-center justify-center gap-3 border-t border-border/40 pt-4"
                >
                    {
                        activeSocials.map(({ name, href, linkTitle }) => (
                            <Button
                                key={name}
                                variant="ghost"
                                size="icon"
                                asChild
                            >
                                <a
                                    href={href}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    aria-label={linkTitle ?? name}
                                >
                                    <Icon name={name} class="size-5" />
                                </a>
                            </Button>
                        ))
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    import { initMobileMenu } from "@/lib/menu";
    document.addEventListener("astro:page-load", initMobileMenu);
</script>
